@{
    var roomName = ViewBag.RoomName as string;
}

<div class="h-screen bg-[#0f172a] text-white flex flex-col">

    <!-- TOP BAR -->
    <div class="flex items-center justify-between px-6 py-3 bg-[#020617] border-b border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            <h2 class="font-semibold text-lg">Oda: @roomName</h2>
        </div>
        <span class="text-sm text-slate-400">Bağlı</span>
    </div>

    <!-- MAIN -->
    <div class="flex flex-1 overflow-hidden">

        <!-- VIDEO AREA -->
        <div class="flex-1 bg-[#020617] p-4 grid grid-cols-2 gap-4">

            <!-- LOCAL -->
            <div class="relative bg-black rounded-2xl overflow-hidden shadow-lg">
                <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <span class="absolute bottom-2 left-2 text-xs bg-black/60 px-2 py-1 rounded">Sen</span>
            </div>

            <!-- REMOTE -->
            <div class="relative bg-black rounded-2xl overflow-hidden shadow-lg">
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <span class="absolute bottom-2 left-2 text-xs bg-black/60 px-2 py-1 rounded">Katılımcı</span>
            </div>

        </div>

        <!-- RIGHT PANEL -->
        <div class="w-80 bg-[#020617] border-l border-slate-800 flex flex-col">

            <!-- PARTICIPANTS -->
            <div class="p-4 border-b border-slate-800">
                <h3 class="font-semibold mb-3">Katılımcılar</h3>
                <ul id="participants" class="space-y-2 text-sm text-slate-300">
                    <li class="bg-slate-800 px-3 py-2 rounded-lg">Sen</li>
                </ul>
            </div>

            <!-- CHAT -->
            <div class="flex-1 p-4 overflow-y-auto">
                <h3 class="font-semibold mb-3">Sohbet</h3>
                <div id="chatMessages" class="space-y-2 text-sm text-slate-300"></div>
            </div>

            <div class="p-3 border-t border-slate-800">
                <input id="chatInput"
                       class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:outline-none"
                       placeholder="Mesaj yaz..." />
            </div>

        </div>

    </div>

    <!-- CONTROL BAR -->
    <div class="bg-[#020617] border-t border-slate-800 py-4 flex justify-center gap-6">

        <button class="w-12 h-12 bg-slate-700 hover:bg-slate-600 rounded-full text-xl">🎤</button>
        <button class="w-12 h-12 bg-slate-700 hover:bg-slate-600 rounded-full text-xl">📷</button>

        <button class="px-6 py-3 bg-red-600 hover:bg-red-500 rounded-full font-semibold"
                onclick="window.location='/Dashboard'">
            Toplantıdan Çık
        </button>

    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="~/js/meeting.js"></script>


<script>
    const roomName = "@roomName";
    const userName = "User_" + Math.floor(Math.random() * 1000);

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/meetingHub")
        .build();

    connection.start().then(async () => {

    await startMedia();

    connection.invoke("JoinRoom", roomName, userName);

    // odaya giren ilk kişi offer oluşturur
    setTimeout(() => {
    createOffer();
    }, 1000);
    });


    connection.on("UserJoined", user => {
        const el = document.createElement("div");
        el.textContent = user + " katıldı";
        document.getElementById("chatMessages").appendChild(el);
    });

    connection.on("ReceiveMessage", (user, message) => {
        const el = document.createElement("div");
        el.textContent = user + ": " + message;
        document.getElementById("chatMessages").appendChild(el);
    });

    document.getElementById("chatInput")
        .addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                connection.invoke("SendMessage", roomName, userName, this.value);
                this.value = "";
            }
        });

    let localStream;
    let peerConnection;

    const servers = {
    iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
    ]
    };

    async function startMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
    });

    document.getElementById("localVideo").srcObject = localStream;
    }

    function createPeerConnection() {
    peerConnection = new RTCPeerConnection(servers);

    localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = event => {
    if (event.candidate) {
    connection.invoke("SendIceCandidate", roomName, JSON.stringify(event.candidate));
    }
    };
    }
    async function createOffer() {
    createPeerConnection();

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    connection.invoke("SendOffer", roomName, JSON.stringify(offer));
    }

    connection.on("ReceiveOffer", async offer => {
    createPeerConnection();

    await peerConnection.setRemoteDescription(
    new RTCSessionDescription(JSON.parse(offer))
    );

    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    connection.invoke("SendAnswer", roomName, JSON.stringify(answer));
    });

    connection.on("ReceiveAnswer", async answer => {
    await peerConnection.setRemoteDescription(
    new RTCSessionDescription(JSON.parse(answer))
    );
    });

    connection.on("ReceiveIceCandidate", async candidate => {
    await peerConnection.addIceCandidate(
    new RTCIceCandidate(JSON.parse(candidate))
    );
    });

</script>
