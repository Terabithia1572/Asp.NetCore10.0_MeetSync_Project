@{
    ViewData["Title"] = "Meeting Room";
    var roomId = ViewBag.RoomId;
}

<h2>Meeting Room</h2>
<p>Room Id: <b>@roomId</b></p>

<input type="text" id="userName" placeholder="User name" />
<button onclick="joinRoom()">Join</button>

<hr />

<video id="localVideo" autoplay playsinline muted width="300"></video>
<video id="remoteVideo" autoplay playsinline width="300"></video>

<form method="post" action="/Room/Create">
    <input name="name" placeholder="Room Name" />
    <button type="submit">Create Room</button>
</form>


<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const roomId = "@roomId";

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/meetingHub")
        .build();

    let peerConnection;
    let localStream;
    let isInitiator = false;

    const servers = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    connection.start();

    async function joinRoom() {
        const user = document.getElementById("userName").value;

        await startMedia();
        createPeerConnection();

        connection.invoke("JoinRoom", roomId, user);
    }

    async function startMedia() {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });

        document.getElementById("localVideo").srcObject = localStream;
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(servers);

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = event => {
            document.getElementById("remoteVideo").srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                connection.invoke("SendIceCandidate", roomId, JSON.stringify(event.candidate));
            }
        };
    }

    // 👇 yeni kullanıcı gelince offer oluştur
    connection.on("NewUserJoined", async () => {
        isInitiator = true;

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        connection.invoke("SendOffer", roomId, JSON.stringify(offer));
    });

    connection.on("ReceiveOffer", async offer => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)));

        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        connection.invoke("SendAnswer", roomId, JSON.stringify(answer));
    });

    connection.on("ReceiveAnswer", async answer => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
    });

    connection.on("ReceiveIceCandidate", async candidate => {
        await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)));
    });
</script>
